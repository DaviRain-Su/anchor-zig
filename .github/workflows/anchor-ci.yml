name: Anchor CI

on:
  push:
    branches: [dev, main]
    paths:
      - ".github/workflows/anchor-ci.yml"
      - "src/**"
      - "build.zig"
      - "build.zig.zon"
      - "install-solana-zig.sh"
  pull_request:
    branches: [dev, main]
    paths:
      - ".github/workflows/anchor-ci.yml"
      - "src/**"
      - "build.zig"
      - "build.zig.zon"
      - "install-solana-zig.sh"

env:
  SOLANA_ZIG_VERSION: v1.52.0

jobs:
  anchor-test:
    name: Anchor Tests
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Cache solana-zig
        uses: actions/cache@v4
        with:
          path: solana-zig
          key: solana-zig-${{ env.SOLANA_ZIG_VERSION }}-linux

      - name: Install solana-zig
        run: ./install-solana-zig.sh solana-zig

      - name: Clone solana-program-sdk-zig
        run: |
          git clone --depth 1 https://github.com/joncinque/solana-program-sdk-zig.git ../solana-program-sdk-zig

      - name: Test Anchor
        run: ./solana-zig/zig build test --summary all
